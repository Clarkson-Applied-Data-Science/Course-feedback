{% extends "base.html" %}

{% block content %}
<div class="title-header"> 
     

  {% if me.role == 'admin' %}
    <h2  class="title">Admin Dashboard</h2>
  
</div>
    <div class="dashboard-cards"> 
      <div class="stat-card">
        <p class="stat-value">Total Users: {{ stats.total_users }} </p> 

        <ul class="activity-list">
          {% for role_counts in stats.users %}
            {% for role, count in role_counts.items() %}
              <li>{{ role }}: {{ count }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
 
      <div class="stat-card">
         <p class="stat-value">Total Courses: {{ stats.total_courses }}</p>

        <ul class="activity-list">
          {% for dept_counts in stats.courses %}
            {% for dept, count in dept_counts.items() %}
              <li>{{ dept }}: {{ count }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
 
      <div class="stat-card"> 
      <p class="stat-value">Pending Feedback:{{ stats.pending_feedback }}</p>

      <p class="stat-value">Feedback Length Distribution: </p>
      <ul class="activity-list">
        {% for row in stats.feedback_length_distribution %}
          <li>
            <span>{{ row.bucket }}</span>: {{ row.count }}
          </li>
        {% endfor %}
      </ul>
    </div>

      <div class="stat-card">  
  <p class="stat-value">New course suggestions: {{ stats.new_suggestions_course }}</p>
        </div>
         <div class="stat-card">  
        <p class="stat-value"> Avg courses per department:  {{ stats.avg_courses_per_department | round(2) }}</p>
        </div>
</div>
<section class="dashboard-section">
  <h3>Feedback by Course (Max / Avg Length)</h3>

  <canvas id="feedbackByCourseChart"></canvas>

  <script>
    const feedbackByCourse = {{ stats.feedback_char_by_course | tojson | safe }};
    const labels = feedbackByCourse.map(row => row.course);
    const feedbackCounts = feedbackByCourse.map(row => row.feedback_count);
    const maxChars = feedbackByCourse.map(row => row.max_chars);
    const avgChars = feedbackByCourse.map(row => row.avg_chars);
    const ctx = document.getElementById('feedbackByCourseChart').getContext('2d');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: '# Feedback',
            data: feedbackCounts,
            yAxisID: 'y',
          },
          {
            label: 'Max Length (chars)',
            data: maxChars,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: '# Feedback' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Chars' },
            grid: { drawOnChartArea: false }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: false
          }
        }
      }
    });
  </script>
</section>

 <section class="dashboard-section">
  <h3>Average Rating by Course</h3>

  <canvas id="courseRatingsChart"></canvas>

  <script>
    const courseRatings = {{ stats.course_rating_avg | tojson | safe }};
    const courseRatingLabels = courseRatings.map(row => row.courseName);
    const courseAvgRatings   = courseRatings.map(row => row.avg_rating);

    const ctxCourseRatings = document
      .getElementById('courseRatingsChart')
      .getContext('2d');

    new Chart(ctxCourseRatings, {
      type: 'bar',  // vertical bar chart
      data: {
        labels: courseRatingLabels,
        datasets: [{
          label: 'Average Rating',
          data: courseAvgRatings,
          // Chart.js will pick default colors; you can add backgroundColor if you want
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 5,  // rating scale 1–5
            title: {
              display: true,
              text: 'Average rating (1–5)'
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: false
          }
        }
      }
    });
  </script>
</section>

<section class="dashboard-section">
  <h3>Feedback by User</h3>
  <table class="activity-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Total Feedback</th>
        <th>Avg Length (chars)</th>
        <th>Avg # Responses</th>
      </tr>
    </thead>
    <tbody>
      {% for row in stats.feedback_by_user %}
        <tr>
          <td>{{ row.name }}</td>
          <td>{{ row.feedback_count }}</td>
          <td>{{ row.avg_chars | round(1) }}</td> 
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section> 



  {% endif %}

{% endblock %}
